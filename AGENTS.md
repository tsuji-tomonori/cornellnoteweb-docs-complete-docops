# ドキュメント運用の前提（Codex向け）

このリポジトリ（Vault）は **Obsidianで管理するMarkdownドキュメント**です。  
Codex は、以下のルールに従ってドキュメントを作成/更新してください。

## 0. 最重要ルール
- **1トピック=1ファイル**（「一覧を1ファイルにまとめる」ことは禁止）
  - 例: 用語集は「用語1件=1ファイル」
- **ファイル名 = ドキュメントID**（例: `RQ-FR-001.md`）
- ドキュメント間の関係は **Obsidianリンク**で表現する（`[[RQ-FR-001]]`）
- 図はすべて **Mermaid** で記載する（画像貼付けや外部作図ツール依存は避ける）
- `docs/**` 配下に **README.md / TEMPLATE.md を置かない**（禁止）
- 本文に **「上位文書」「下位文書」** セクションを作らない（関係は Frontmatter の `up/related` のみ）

## 1. Frontmatter（YAML）規約
対象: `docs/**/` 配下のドキュメント。

必須キー（原則）:
- `id` / `title` / `doc_type` / `phase`
- `version` / `status` / `owner`
- `created` / `updated`（ISO日付 `YYYY-MM-DD`）
- `up` / `related`（Obsidianリンク配列）
- `tags`（文字列配列）

更新時ルール:
- 変更を入れたら **`updated` を当日の日付**へ更新
- 変更が軽微な誤字修正のみなら `version` は維持でOK
- 内容変更（要求/設計/テストの意味が変わる）なら **patch を上げる**（例: `1.0.0 -> 1.0.1`、Semantic Versioning準拠）

値の運用ルール（必須）:
- `doc_type`: ドキュメントの役割名を記載する（例: 機能要求、要求決定記録、構成管理）。同種別で表記ゆれを作らない。
- `phase`: `RQ/BD/DD/UT/IT/AT` のいずれか。ID prefix と一致させる（例: `RQ-FR-*` は `phase: RQ`）。
- `version`: Semantic Versioning（`MAJOR.MINOR.PATCH`）で管理する。通常は `PATCH` を更新し、意味変更なしの軽微修正では据え置き可。
- `status`: `下書き` または `承認` を使用し、承認済み内容を失効させる場合のみ `廃止` を使用する。
- `owner`: `RQ-SH-*`（ステークホルダー）で定義された責務ロールのみを記載する。未定義ロールを使う場合は先にSHを更新する。

## 2. リンク（トレーサビリティ）規約
- `up` : 上位（目的/スコープ/UCなど）
- `related` : 横断（同レベルの関連、参照、依存）

整合ルール:
- `A.up` に `P` を追加したら、Backlinkで `P -> A` が辿れることを確認する
- `related` は片方向でもよいが、可能なら相互にしてBacklinkの密度を上げる

## 3. 要求（FR/NFR）記述規約
- 機能要求（FR）・非機能要求（NFR）は **SnowCard形式（日本語）**を基本とする。
- 要求を新規追加・意味変更する場合は、**対応するRDR（要求決定記録）を必須**とする。
- SnowCardの最小項目:
  - 要求ID / 種別 / 優先度
  - 要求（1文で）/ 根拠
  - 受入基準（箇条書き）
  - 例外/エラー
  - 依存/関連（必要ならリンク）
- SnowCardの**必須記載項目（要求ID/種別/優先度/要求/根拠/受入基準/例外/依存・関連）**を、要求/設計資料または `doc-rq-*` スキルに明記する。
- SnowCardの `優先度` は RFC 2119（`MUST` / `SHOULD` / `MAY`）に従って記載する。

## 4. 図（Mermaid）規約
- ER図 / アーキテクチャ / フロー / シーケンス図は ` ```mermaid ` で記載する。
- Mermaid以外（画像・PlantUML等）は使わない。

## 5. 変更履歴
各ドキュメントの末尾に `## 変更履歴` を置き、日付+要約を追記する。  
（例）`- 2026-01-31: 初版`

## 6. RTM（マトリックス）について
- 静的な「要求トレーサビリティマトリックス（手更新の表）」は作らない。
- 必要な可視化は **Obsidian + Dataview** で生成する。
  - 例: `docs/1.要求(RQ)/71.要求トレーサビリティマトリックス(RTM)/RQ-RTM-001.md`

## 7. 上位⇄下位の同期フロー（必須）
変更を入れたら、リンクグラフ上の影響範囲を **更新 or 確認** する。

### 7.1 上位→下位（トップダウン）
1. 上位ドキュメント（例: PP/SC/UC/FR/NFR）を更新
2. `up` の逆方向（Backlink）で辿れる下位を洗い出す（設計/テスト含む）
3. 各下位について、次のどちらかを必ず実施
   - **更新**: 仕様の意味が変わる場合は、下位の本文・受入基準・図・テスト観点を更新
   - **確認**: 影響なしなら、整合性確認の結果を `reports/impact_check_YYYY-MM-DD.md` に記録

### 7.2 下位→上位（ボトムアップ）
1. 下位ドキュメント（例: DD/UT/IT/AT）を更新
2. `up` で辿れる上位を洗い出す（要求/設計/戦略含む）
3. 各上位について、次のどちらかを必ず実施
   - **更新**: 上位の制約・前提・受入基準・品質特性が変わる場合は本文を更新
   - **確認**: 影響なしなら、整合性確認の結果を `reports/impact_check_YYYY-MM-DD.md` に記録

### 7.3 仕上げ
- 最後に `$obsidian-doc-check` を実行し、`reports/doc_check.md` を更新する。

### 7.4 決定記録（必須ゲート）
- 要求の追加/意味変更を行う場合、同一PRで **RDR** を新規作成または更新する。
- 設計の新規記載/意味変更を行う場合、同一PRで **ADR** を新規作成または更新する。
- 設計が要求起点の場合は、`RDR -> ADR -> 設計本文` の順で辿れるリンクを必須にする。

## 8. 推奨エージェント（役割分担）
Codex は変更内容に応じて、次の「役割」を意識して文書品質を担保する（`agents/` を参照）。
- **Requirements Writer**: PP/SC/UC/FR/NFR の整合、SnowCardの品質
- **System Architect**: ADR/アーキテクチャ、分割、依存関係
- **Data Modeler**: ドメインモデル、ERD、DDL、移行
- **API Designer**: API設計（BD/DD）とシーケンス
- **UI/UX Designer**: 画面遷移、UX、アクセシビリティ
- **Security & Privacy**: セキュリティ/プライバシー要求と設計
- **SRE/Observability**: 可用性/性能/監視/運用の観点
- **QA/Test Engineer**: UT/IT/AT 戦略・ケース・データ・レポート

## 9. Codex Skills 運用
- ドキュメント更新は、対象種別に対応する `doc-*` スキルを使う（**1スキル=1ドキュメント種別**）。
- 種別を新設/改名/廃止した場合は、同一PRで対応スキルを追加/更新する。
- 規約変更（Frontmatter、リンク、レビュー基準、改修フロー）が入った場合は、共通スキル（`docops-orchestrator` / `obsidian-doc-*`）も同時更新する。
- スキルの保守は `skill-maintainer` を基準とし、更新タイミングを `RQ-DG` と `BD-CM` に反映する。

## 10. コミットメッセージ規約
- コミットメッセージは Conventional Commits（`type(scope)!: subject`）に従う。
- `type` は `feat` / `fix` / `docs` / `refactor` / `test` / `chore` などを使用する。
- `subject` と本文は日本語で記載する。
- 詳細は `/.gitmessage` と `git-commit` スキルに従う。
