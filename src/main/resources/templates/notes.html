<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ノート一覧 - Cornell Note</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <a href="#mainContent" class="skip-link">本文へスキップ</a>
  <div class="app-container">
    <header class="header">
      <a href="/notes" class="header-logo">Cornell Note</a>
      <form class="header-search" role="search">
        <label class="visually-hidden" for="searchInput">ノートを検索</label>
        <input type="text" placeholder="ノートを検索..." id="searchInput" autocomplete="off">
      </form>
      <div class="header-actions">
        <button type="button" class="header-user" id="userMenu" aria-haspopup="true" aria-expanded="false" aria-controls="userDropdown" aria-label="ユーザーメニュー">
          <div class="user-avatar" id="userAvatar">D</div>
          <span id="userName">Demo User</span>
        </button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="sidebar-section">
        <button class="btn btn-primary btn-full" id="newNoteBtn">
          + 新規ノート
        </button>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ノートブック</div>
        <div id="notebookList"></div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">タグ</div>
        <div id="tagList"></div>
      </div>

      <div class="sidebar-section" style="margin-top: auto;">
        <a href="/settings" class="sidebar-item">
          <span class="sidebar-item-icon">&#9881;</span>
          設定
        </a>
        <a href="#" class="sidebar-item" id="logoutBtn">
          <span class="sidebar-item-icon">&#10140;</span>
          ログアウト
        </a>
      </div>
    </aside>

    <main class="main-content" id="mainContent" tabindex="-1">
      <div class="note-list-header">
        <h1 class="note-list-title" id="pageTitle">すべてのノート</h1>
        <div>
          <span id="noteCount" style="color: var(--text-secondary); font-size: 0.875rem;">0 件</span>
        </div>
      </div>

      <div class="note-grid" id="noteGrid"></div>

      <div id="emptyState" class="hidden" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
        <p style="font-size: 1.125rem; margin-bottom: 8px;">ノートがありません</p>
        <p>「新規ノート」ボタンから最初のノートを作成しましょう</p>
      </div>
    </main>
  </div>

  <div id="userDropdown" class="hidden" role="menu" aria-label="ユーザーメニュー" style="position: fixed; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px 0; min-width: 160px; z-index: 150;">
    <a href="/settings" role="menuitem" style="display: block; padding: 8px 16px; color: var(--text-primary); text-decoration: none; font-size: 0.875rem;">設定</a>
    <a href="#" id="dropdownLogout" role="menuitem" style="display: block; padding: 8px 16px; color: var(--error-color); text-decoration: none; font-size: 0.875rem;">ログアウト</a>
  </div>

  <div id="statusRegion" class="visually-hidden" role="status" aria-live="polite"></div>
  <div id="alertRegion" class="visually-hidden" role="alert" aria-live="assertive"></div>

  <script src="/js/app.js"></script>
  <script>
    const { api, storage, ui, navigateTo, requireAuth, logout, initSearch } = CornellApp;

    if (!requireAuth()) {
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadUserInfo();
      await loadNotebooks();
      await loadTags();
      await loadNotes();
      initSearch();
      setupEventListeners();
    });

    async function loadUserInfo() {
      const session = storage.getSession();
      if (session) {
        document.getElementById('userName').textContent = session.displayName || session.email;
        document.getElementById('userAvatar').textContent = (session.displayName || session.email).charAt(0).toUpperCase();
      }
    }

    async function loadNotebooks() {
      const data = await api.getNotebooks();
      const container = document.getElementById('notebookList');

      if (data && data.notebooks) {
        container.innerHTML = `
          <a href="#" class="sidebar-item active" data-filter="all">
            <span class="sidebar-item-icon">&#128196;</span>
            すべて
          </a>
          ${data.notebooks.map(nb => `
            <a href="#" class="sidebar-item" data-filter="notebook" data-id="${nb.notebookId}">
              <span class="sidebar-item-icon">&#128209;</span>
              ${nb.name}
            </a>
          `).join('')}
        `;
      }
    }

    async function loadTags() {
      const data = await api.getTags();
      const container = document.getElementById('tagList');

      if (data && data.tags) {
        container.innerHTML = data.tags.map(tag => `
          <a href="#" class="sidebar-item" data-filter="tag" data-id="${tag.tagId}">
            <span class="sidebar-item-icon">#</span>
            ${tag.name}
          </a>
        `).join('');
      }
    }

    async function loadNotes(filter = null) {
      const data = await api.getNotes();
      const grid = document.getElementById('noteGrid');
      const emptyState = document.getElementById('emptyState');
      const noteCount = document.getElementById('noteCount');

      if (data && data.notes && data.notes.length > 0) {
        let notes = data.notes;

        if (filter) {
          if (filter.type === 'notebook') {
            notes = notes.filter(n => n.notebookId === filter.id);
          } else if (filter.type === 'tag') {
            notes = notes.filter(n => n.tags.some(t => t.tagId === filter.id));
          }
        }

        noteCount.textContent = `${notes.length} 件`;
        ui.announceStatus(`${notes.length} 件のノートを表示しています`);

        if (notes.length === 0) {
          grid.classList.add('hidden');
          emptyState.classList.remove('hidden');
          ui.announceStatus('表示できるノートがありません');
        } else {
          grid.classList.remove('hidden');
          emptyState.classList.add('hidden');
          grid.innerHTML = notes.map(note => `
            <button type="button" class="note-card" data-note-id="${note.noteId}" aria-label="${note.title} を開く">
              <div class="note-card-title">${note.title}</div>
              <div class="note-card-preview">${note.preview}</div>
              <div class="note-card-meta">
                <span>${ui.formatDate(note.updatedAt)}</span>
              </div>
              ${note.tags.length > 0 ? `
                <div class="note-card-tags">
                  ${note.tags.map(tag => `<span class="tag">${tag.name}</span>`).join('')}
                </div>
              ` : ''}
            </button>
          `).join('');
        }
      } else {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        noteCount.textContent = '0 件';
        ui.announceStatus('ノートが見つかりません');
      }
    }

    function setupEventListeners() {
      document.getElementById('newNoteBtn').addEventListener('click', () => {
        navigateTo('/editor', { id: 'new' });
      });

      document.getElementById('noteGrid').addEventListener('click', (e) => {
        const card = e.target.closest('.note-card');
        if (card) {
          const noteId = card.dataset.noteId;
          navigateTo('/editor', { id: noteId });
        }
      });

      document.getElementById('noteGrid').addEventListener('keydown', (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        const card = e.target.closest('.note-card');
        if (card) {
          e.preventDefault();
          const noteId = card.dataset.noteId;
          navigateTo('/editor', { id: noteId });
        }
      });

      document.querySelectorAll('#notebookList, #tagList').forEach(container => {
        container.addEventListener('click', (e) => {
          e.preventDefault();
          const item = e.target.closest('.sidebar-item');
          if (!item) return;

          document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          const filterType = item.dataset.filter;
          const filterId = item.dataset.id;
          const pageTitle = document.getElementById('pageTitle');

          if (filterType === 'all') {
            pageTitle.textContent = 'すべてのノート';
            loadNotes();
          } else if (filterType === 'notebook') {
            pageTitle.textContent = item.textContent.trim();
            loadNotes({ type: 'notebook', id: filterId });
          } else if (filterType === 'tag') {
            pageTitle.textContent = `#${item.textContent.trim().replace('#', '')}`;
            loadNotes({ type: 'tag', id: filterId });
          }
        });

        container.addEventListener('keydown', (e) => {
          if (e.key !== 'Enter' && e.key !== ' ') return;
          const item = e.target.closest('.sidebar-item');
          if (!item) return;
          e.preventDefault();
          item.click();
        });
      });

      const userMenu = document.getElementById('userMenu');
      const userDropdown = document.getElementById('userDropdown');

      userMenu.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = userMenu.getBoundingClientRect();
        userDropdown.style.top = `${rect.bottom + 8}px`;
        userDropdown.style.right = `${window.innerWidth - rect.right}px`;
        const isHidden = userDropdown.classList.toggle('hidden');
        userMenu.setAttribute('aria-expanded', (!isHidden).toString());
        if (!isHidden) {
          userDropdown.querySelector('a')?.focus();
        }
      });

      userMenu.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        e.preventDefault();
        userMenu.click();
      });

      document.addEventListener('click', () => {
        userDropdown.classList.add('hidden');
        userMenu.setAttribute('aria-expanded', 'false');
      });

      document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });

      document.getElementById('dropdownLogout').addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });
    }
  </script>
</body>
</html>
